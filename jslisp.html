<!DOCTYPE HTML>
<html>
  <body>
    <div style="position:absolute; left:0px; top:0px; right:0px; bottom:28px; padding:8px">
      <textarea type=text id="repl" style="width:100%; height:100%; background-color:#EEEEEE; border:none; outline:none; padding:0px; margin:0px; font-family:Courier New; font-size:18px"
           onkeydown = "keyDown(event)"
           onkeypress = "keyPress(event)"></textarea>
    </div>
    <div id="clpar" style="position:absolute; background-color:#EEEEEE; bottom:8px; left:8px; right:8px; height:20px; font-family:Courier New; font-size:18px; color:#808080"></div>
    <script src="jslisp.js">
    </script>
    <script>

var prompt = "Ready.";
var repl = document.getElementById("repl");
var clpar = document.getElementById("clpar");
repl.focus();

function updateClpar(text)
{
    if (text == undefined)
    {
        text = repl.value.substr(0, repl.selectionStart);
        var li = text.lastIndexOf("\n"+prompt+"\n");
        if (li != -1) text = text.substr(li+2+prompt.length);
    }

    var i = 0;
    var indent = [];
    var skip_spaces = function()
    {
        while (i < text.length && " \r\n\t".indexOf(text[i]) != -1)
            ++i;
    };

    var defs = ["defun", "defmacro", "defstruct",
                "let", "let*", "do",
                "when", "unless",
                "dotimes", "dolist", "lambda"];

    var parse = function()
    {
        skip_spaces();
        if (text[i] == '(')
        {
            var fsp = text.indexOf(" ", i);
            var def = (fsp != -1) && defs.indexOf(text.substr(i+1, fsp-i-1)) != -1;
            indent.push([i, 0, i + (def ? 2 : 4)]);
            ++i;
            skip_spaces();
            while (i < text.length && text[i] != ')')
            {
                if (++indent[indent.length-1][1] == 2 && !def)
                    indent[indent.length-1][2] = i-1;
                parse();
                skip_spaces();
            }
            i++;
            if (i >= text.length)
                throw indent;
            indent.pop();
        }
        else if (text[i] == '"' || text[i] == '|')
        {
            var q = text[i++];
            while (i < text.length && text[i] != q)
            {
                if (text[i] == '\\') i++;
                i++;
            }
            i++;
        }
        else if (text[i] == ';')
        {
            while (i < text.length && text[i] != '\n')
                i++;
            i++;
        }
        else if (text[i] == '#')
        {
            i++;
            if (text[i] == '\\') i+=2;
            while (i < text.length && "() \t\n\r".indexOf(text[i]) == -1)
                i++;
        }
        else
        {
            while (i < text.length && "() \t\n\r".indexOf(text[i]) == -1)
                i++;
            while (indent.length == 0 && i < text.length && text[i] == ')')
                i++;
        }
    };

    try
    {
        while (i < text.length)
            parse();
    }
    catch(indent)
    {
        if (text[text.length-1] == ")")
        {
            var s = indent[indent.length-1][0];
            var msg = "closes " + text.substr(s, 20) + (s < text.length-20 ? " ..." : "");
            clpar.innerHTML = htmlesc(msg.replace(/\n/g," ").replace(/ +/g, " "));
            indent.pop();
        }
        else
        {
            var f = text.substr(1 + indent[indent.length-1][0]);
            var sp = f.indexOf(" ");
            if (sp != -1) f = f.substr(0, sp);
            clpar.innerHTML = f + " (#" + indent[indent.length-1][1] + ")";
        }
        if (indent.length == 0)
            return 0;
        var i = indent[indent.length-1][2];
        return i - text.lastIndexOf("\n", i);
    }
    clpar.innerHTML = "";
    return 0;
}

setInterval(function(){updateClpar();}, 100);

function htmlesc(x)
{
    return (x
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/ /g, "&nbsp;")
            .replace(/\n/g, "<br/>"));
}

function f$$display(x)
{
    repl.value += x + "\n";
    var i = repl.value.length;
    repl.setSelectionRange(i, i);
    repl.scrollTop = repl.scrollHeight;
    repl.focus();
    return x;
};

function process()
{
    var base = repl.value;
    var li = base.lastIndexOf("\n"+prompt+"\n");
    base = base.substr(li == -1 ? 0 : li+2+prompt.length).replace(/\t\n *$/,"");
    try
    {
        var xx = 0;
        var src = function(n) { var c = base[xx]; xx+=(n|0); return c; };
        f$$skip_spaces(src);
        while (xx < base.length)
        {
            var pp = f$$parse_value(src);
            var result = eval(f$$js_compile(pp));
            f$$display("--> " + f$$str_value(result));
            f$$skip_spaces(src);
        }
    }
    catch (err)
    {
        err = ("" + err).replace(/[dmf]\$\$([a-zA-Z_]|(\$[0-9]+\$))*/g,
                                 function(s)
                                 {
                                     return {"d" : "",
                                             "m" : "macro ",
                                             "f" : "function "}[s[0]] + f$$demangle(s.substr(1));
                                 });
        f$$display("**ERROR**: " + err);
    }
    f$$display(prompt);
}

function keyDown(e)
{
    if (e.which == 9)
    {
        e.preventDefault();
        var text = repl.value;
        var ss = repl.selectionStart;
        var se = repl.selectionEnd;
        var lines = text.split("\n");
        var before = text.substr(0, ss).replace(/[^\n]/g,"").length;
        var after = 1 + text.substr(0, se).replace(/[^\n]/g,"").length;
        var nt = lines.slice(0, before).join("\n"); if (before) nt += "\n";
        var ns = nt.length;
        for (var i=before; i<after; i++)
        {
            indent = updateClpar(nt);
            var sp = "";
            while (indent > 0)
            {
                --indent;
                sp += " ";
            }
            var L = lines[i];
            while (L[0] == ' ') L = L.substr(1);
            nt += sp + L + "\n";
        }
        var ne = nt.length-1;
        nt += lines.slice(after).join("\n");
        while (nt[nt.length-1] == "\n")
            nt = nt.substr(0, nt.length-1);
        repl.value = nt;
        repl.setSelectionRange(ne, ne);
        repl.focus();
    }
}

function keyPress(e)
{
    if (e.which == 10 || (e.which == 13 && (e.ctrlKey || e.shiftKey)))
    {
        process();
        e.preventDefault();
    }
    else if (e.which == 13)
    {
        e.preventDefault();
        var level = updateClpar();
        var text = repl.value;
        var i = repl.selectionStart;
        var sp = "";
        for (var j=0; j<level; j++)
            sp += " ";
        repl.value = text.substr(0, i) + "\n" + sp + text.substr(i);
        repl.setSelectionRange(i + 1 + sp.length, i + 1 + sp.length);
        if (sp == "" && repl.selectionStart == repl.value.length)
            process();
        repl.scrollTop = repl.scrollHeight;
    }
}

function f$$ajax(url, cback, error)
{
    var xmlhttp = new XMLHttpRequest();
    xmlhttp.onreadystatechange=function()
    {
        if (xmlhttp.readyState == 4)
        {
            if (xmlhttp.status == 200)
            {
                cback(xmlhttp.responseText);
            }
            else
            {
                if (error)
                {
                    error(xmlhttp.status);
                }
                else
                {
                    alert("Ajax request error: status=" + xmlhttp.status);
                }
            }
        }
    };
    xmlhttp.open("GET", url, true);
    xmlhttp.send();
}

// Bootstrap
f$$ajax("boot.lisp",
        function(boot)
        {
            try
            {
                f$$load(boot);
                f$$display("Boot completed");
            }
            catch(err)
            {
                f$$display("Bootstrap error: " + err);
            }
            f$$display(prompt);
        },
        function(err)
        {
            f$$display("Bootstrap ajax error: status=" + err)
            f$$display(prompt);
        });
    </script>
  </body>
</html>
